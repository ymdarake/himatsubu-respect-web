# 仕様書

## ステータスシステム

### 基礎ステータス (BaseStats)

プレイヤーの基本能力値で、レベルアップ時にポイントを割り振って強化できます。

| ステータス | 英名 | 効果 |
|-----------|------|------|
| 腕力 | strength | 物理攻撃力とHPに影響 |
| 体力 | stamina | HPと物理防御力に影響 |
| 知力 | intelligence | 魔法攻撃力と防御力に影響 |
| 敏捷 | speedAgility | 攻撃速度と回避に影響 |
| 幸運 | luck | クリティカル率、ドロップ率、ゴールド獲得量に影響 |

### 派生ステータス (DerivedStat)

基礎ステータスと装備から自動計算される値です。

| ステータス | 英名 | 計算方法 |
|-----------|------|---------|
| HP | maxHp | 基礎値 + (stamina × 10) + (strength × 2) + 装備ボーナス |
| 物理攻撃 | physicalAttack | 基礎値 + (strength × 2) + 装備ボーナス |
| 物理防御 | physicalDefense | 基礎値 + (stamina × 1.5) + 装備ボーナス |
| 魔法攻撃 | magicalAttack | 基礎値 + (intelligence × 2) + 装備ボーナス |
| 魔法防御 | magicalDefense | 基礎値 + (intelligence × 1.5) + 装備ボーナス |
| 素早さ | speed | 基礎値 + (speedAgility × 2) + 装備ボーナス |
| 運気値 | luckValue | 基礎値 + (luck × 2) + 装備ボーナス |

**実装**: `utils/statCalculations.ts` の `calculateDerivedStats()` 関数

### レベルアップ

- **経験値**: 敵を倒すと獲得（ステージが進むほど増加）
- **必要経験値**: レベルアップごとに増加（XP_FOR_NEXT_LEVEL_MULTIPLIER）
- **ポイント割り振り**: レベルアップ時に3ポイント獲得し、基礎ステータスに自由に配分
- **自動割り振り**: 前回の割り振りをロックすることで、以降のレベルアップを自動化可能

## 装備システム

### 装備の種類

| タイプ | 説明 | 主な効果 |
|-------|------|---------|
| 武器 (weapon) | 攻撃力を高める | 物理攻撃、魔法攻撃、属性ダメージ |
| 防具 (armor) | 防御力を高める | HP、物理防御、魔法防御 |
| アクセサリー (accessory) | 特殊効果 | 速度、運気、属性ダメージ |

### レア度

装備には5段階のレア度があり、レア度が高いほどステータス値が高くなります。

| レア度 | 英名 | ステータス倍率 |
|-------|------|--------------|
| コモン | common | 1.0x |
| アンコモン | uncommon | 1.2x |
| レア | rare | 1.5x |
| エピック | epic | 2.0x |
| レジェンダリー | legendary | 3.0x |

### 装備の成長

- 装備はドロップ時にレベルを持つ（ステージに応じたレベル）
- 装備のステータスは `基礎値 + (成長値 × レベル)` で計算
- 装備レベルの強化は未実装（将来的な拡張可能）

### 装備の入手方法

1. **ドロップ**: 敵を倒すと一定確率でランダム装備がドロップ
   - 基礎ドロップ率: `BASE_DROP_CHANCE`（5%）
   - 運気ボーナス: `運気値 × LUCK_TO_DROP_CHANCE_MULTIPLIER`
2. **ショップ購入**: 3ステージごとに出現するショップで購入
   - 武器ショップ、防具ショップ、アクセサリーショップ
   - 価格は装備レベルとレア度に応じて変動

### 属性ダメージ

一部の装備は属性ダメージを持ちます：

| 属性 | 説明 |
|-----|------|
| 火 | 高ダメージ、水に強く火に弱い |
| 水 | バランス型、火に強く風に弱い |
| 風 | 高速攻撃、水に強く土に弱い |
| 土 | 高防御、風に強く火に弱い |
| 光 | 闇に強い |
| 闇 | 光に強い |
| 無 | 相性なし |

**実装**: `constants/combat.ts` の `ELEMENTAL_AFFINITY` 定数

## 戦闘システム

### ダメージ計算

#### 物理ダメージ

```
基礎ダメージ = 攻撃力 / (攻撃力 + 防御力) × 攻撃力
ランダム係数 = 0.9 ～ 1.1
クリティカル倍率 = 通常 1.0 / クリティカル 1.5

最終ダメージ = floor(基礎ダメージ × ランダム係数 × クリティカル倍率)
最小値: 1
```

#### 属性ダメージ

```
基礎魔法ダメージ = 魔法攻撃力 × 1.5 × (1 + 属性パワー / 100)
ランダム係数 = 0.9 ～ 1.1
属性相性倍率 = ELEMENTAL_AFFINITY[攻撃属性][防御属性]

最終ダメージ = floor(基礎魔法ダメージ × ランダム係数 × 属性相性倍率) - 魔法防御
最小値: 1
```

#### クリティカル判定

```
クリティカル率 = min(0.75, 運気値 / 400)
判定: random() < クリティカル率
```

### 攻撃速度

速度ステータスに応じて攻撃クールダウンが変化します。

| 速度比率 | クールダウン時間 |
|---------|---------------|
| ～0.5 | 1200ms |
| 0.5～1.0 | 800ms |
| 1.0～1.5 | 500ms |
| 1.5～ | 300ms |

速度比率 = プレイヤー速度 / 敵速度

**実装**: `constants/combat.ts` の `ATTACK_SPEED_LEVELS`

### 戦闘フロー

1. **プレイヤーターン** (`processPlayerAttack`)
   - 攻撃範囲内（ATTACK_RANGE: 25px）の敵を検出
   - クールダウンチェック
   - ダメージ計算（物理 + 全属性）
   - 敵HP更新
   - 撃破判定とドロップ処理

2. **敵ターン** (`processEnemyAIAndAttacks`)
   - 各敵のAI状態更新（idle → preparing → attacking → idle）
   - 攻撃準備時間（attackPrepareTime）後に攻撃発動
   - プレイヤーへのダメージ適用
   - 次回攻撃までのクールダウン

3. **同時処理**
   - 両者のダメージは同一フレーム内で処理
   - プレイヤーの攻撃が敵AI処理より先に実行される

### 属性相性表

| 攻撃＼防御 | 火 | 水 | 風 | 土 | 光 | 闇 | 無 |
|-----------|----|----|----|----|----|----|---|
| 火 | 0.5 | 1.5 | 1.0 | 0.5 | 1.0 | 1.0 | 1.0 |
| 水 | 0.5 | 0.5 | 1.5 | 1.0 | 1.0 | 1.0 | 1.0 |
| 風 | 1.0 | 0.5 | 0.5 | 1.5 | 1.0 | 1.0 | 1.0 |
| 土 | 1.5 | 1.0 | 0.5 | 0.5 | 1.0 | 1.0 | 1.0 |
| 光 | 1.0 | 1.0 | 1.0 | 1.0 | 1.0 | 1.5 | 1.0 |
| 闇 | 1.0 | 1.0 | 1.0 | 1.0 | 1.5 | 1.0 | 1.0 |
| 無 | 1.0 | 1.0 | 1.0 | 1.0 | 1.0 | 1.0 | 1.0 |

## ワールド構造

### ステージ

- **長さ**: 400m（400 × PIXELS_PER_METER = 40,000px）
- **遷移**: 画面端に到達すると次ステージへ自動移行
- **難易度**: ステージインデックスに応じて敵のレベルが上昇

### エリア

10ステージごとに新しいエリアへ移行します。

| エリア名 | ステージ範囲 | 背景色 | 地面色 |
|---------|------------|--------|--------|
| 草原 | 0-9 | 空色 | 緑 |
| 砂漠 | 10-19 | 黄色 | 茶色 |
| 雪原 | 20-29 | 白 | 青白 |
| 火山 | 30-39 | 赤 | 黒 |
| 森林 | 40+ | 深緑 | 緑茶 |

**実装**: `data/areas.ts` の `AREAS` 配列

### オブジェクト配置

#### ショップ
- **配置間隔**: 3ステージごと
- **種類**: 武器、防具、アクセサリーの3種類をランダム配置
- **在庫**: ステージレベルに応じた装備を5個陳列
- **価格**: 基本価格 × (1 + レベル × 0.1) × レア度倍率

#### 回復の家
- **配置間隔**: 3ステージごと
- **機能**:
  - HP全回復（費用: プレイヤーレベル × 7 ゴールド）
  - 装備変更

#### 転送陣
- **配置間隔**: 10ステージごと（エリアの最後）
- **機能**: 過去の転送陣へワープ
- **費用**: |目的地 - 現在地| × 7 ゴールド

### 敵の配置

- **配置数**: ステージごとに2～5体
- **レベル**: max(1, ステージ × 0.8 + ランダム(-1～+2))
- **位置**: ショップや家を避けてランダム配置

**実装**: `utils/worldGenerator.ts` の `spawnEnemiesForStage()`

## 敵の種類

### 通常敵

基本的な敵タイプです。ステージに応じたレベルで出現します。

| 名前 | 特徴 | 属性 | レア度 |
|-----|------|------|--------|
| スライム | 基本的な敵 | 無 | 低 |
| ゴブリン | バランス型 | 無 | 中 |
| オーク | 高物理攻撃 | 土 | 中 |
| ウィザード | 高魔法攻撃 | 無 | 高 |
| ドラゴン | 高ステータス | 火 | 最高 |

### 特殊敵

低確率で出現する特殊な敵です。

#### ゴールドスライム
- **出現率**: 2%
- **特徴**: 高HP、低攻撃力
- **ドロップ**: (ステージ + 1) × 100 ゴールド
- **属性**: 無

#### ジェムスライム
- **出現率**: 3%
- **特徴**: 通常ステータス
- **ドロップ**: 3～5個のジェム（ランダムなステータス強化アイテム）
- **属性**: 無

#### ヒーリングスライム
- **出現率**: 1%
- **特徴**: 低HP、低攻撃力
- **効果**: 倒すとプレイヤーのHPが全回復
- **属性**: 光

**実装**: `data/enemies.ts` の `ENEMY_DATA`

## セーブシステム

### 保存内容

```typescript
{
  player: {
    level,
    xp,
    xpToNextLevel,
    currentHp,
    gold,
    baseStats,
    equipment,
    inventory,
    statPoints,
    // その他プレイヤー情報
  },
  stageIndex: number,
  playStats: {
    enemiesDefeated,
    totalXpGained,
    totalGoldEarned,
    totalDistanceTraveled,
    farthestDistance,
    gemCollection,
    collectedEquipment,
    playTime,
    // その他統計情報
  }
}
```

### 保存タイミング

1. **自動セーブ**: 10秒ごと（ゲームプレイ中のみ）
2. **手動セーブ**: 「セーブしてタイトルへ戻る」ボタン押下時
3. **ウィンドウクローズ**: ブラウザ/タブを閉じる前

### ロード処理

- セーブデータがある場合、タイトル画面で「つづきから」ボタンが表示
- ロード時、プレイヤーは保存されたステージの開始位置に配置
- ステージの敵とオブジェクトは再生成される

**実装**: `hooks/useGameLogic.ts` の `saveCurrentGame()` と `continueGame()`

## オーディオシステム

### BGM

エリアごとに異なるBGMが再生されます。

- Web Audio APIを使用
- ループ再生
- ミュート機能対応

### 効果音

| 効果音 | タイミング |
|-------|----------|
| playerAttack | プレイヤーが攻撃した時 |
| enemyAttack | 敵が攻撃した時 |
| enemyHit | 敵がダメージを受けた時 |
| playerHit | プレイヤーがダメージを受けた時 |
| playerDeath | プレイヤーが死亡した時 |
| levelUp | レベルアップした時 |

**実装**: `utils/audio.ts`

## UI仕様

### 操作方法

#### デスクトップ
- **移動**: 左右矢印キー
- **アクション**: スペースキー（ショップ/家/転送陣の利用）
- **モーダル閉じる**: Escキー

#### モバイル
- **移動**: 画面左下の方向ボタン
- **アクション**: 画面右下のアクションボタン

### 画面構成

#### ゲームビュー（上部）
- プレイヤーHP表示
- 距離表示
- セーブボタン
- ミュートボタン
- ゲームフィールド（横スクロール）

#### ステータスエリア（中部）

**モバイル版**: 5カラムグリッド
- 左2列: 基礎ステータス + 派生ステータス
- 右3列: 敵情報 or プレイ統計 + 装備表示

**デスクトップ版**: 4カラムグリッド
- 基礎ステータス
- 派生ステータス
- 装備表示
- 敵情報 or プレイ統計

#### ログエリア（下部）
- スクロール可能
- 最新50件を保持
- 戦闘ログ、アイテム取得、レベルアップ等

### モーダル

#### ショップモーダル
- 装備一覧表示
- 購入ボタン（ゴールド不足時は無効化）
- 装備ボタン
- 装備変更タブ

#### レベルアップモーダル
- 獲得ポイント表示
- 基礎ステータス割り振りUI
- ステータスプレビュー
- 自動割り振りロックボタン

#### 装備変更モーダル（回復の家）
- 所持装備一覧
- 装備/外すボタン
- HP回復ボタン

#### 転送陣モーダル
- 訪問済み転送陣一覧
- 転送費用表示
- テレポートボタン

## ゲーム定数

主要な定数は `constants/` ディレクトリで管理されています。

### ゲーム全般 (`constants/game.ts`)

```typescript
GAME_SPEED = 1.0                    // ゲーム全体の速度倍率
PIXELS_PER_METER = 100              // 1メートル = 100ピクセル
STAGE_LENGTH = 400                  // ステージの長さ（メートル）
ATTACK_RANGE = 25                   // 攻撃範囲（ピクセル）
STAT_POINTS_PER_LEVEL = 3           // レベルアップ時の獲得ポイント
BASE_DROP_CHANCE = 0.05             // 基礎ドロップ率（5%）
LUCK_TO_DROP_CHANCE_MULTIPLIER = 0.001  // 運気のドロップ率への影響
ENEMY_PANEL_DISPLAY_RANGE = 200     // 敵ステータス表示範囲（ピクセル）
```

### 戦闘関連 (`constants/combat.ts`)

```typescript
XP_FOR_NEXT_LEVEL_MULTIPLIER = 1.15  // レベルアップ必要経験値の増加率
ATTACK_SPEED_LEVELS = [...]          // 速度とクールダウンの対応表
ELEMENTAL_AFFINITY = {...}           // 属性相性表
```

### プレイヤー初期値 (`constants/player.ts`)

```typescript
INITIAL_PLAYER = {
  level: 1,
  xp: 0,
  xpToNextLevel: 100,
  currentHp: 100,
  gold: 0,
  baseStats: {
    strength: 5,
    stamina: 5,
    intelligence: 5,
    speedAgility: 5,
    luck: 5
  },
  // ...
}
```

## パフォーマンス最適化

### ゲームループ

- **FPS**: 60（16.67ms間隔）
- **実装**: `setInterval` を使用
- **deltaTime**: 固定値（1/60秒）で計算

### React最適化

- **useMemo**: 派生ステータス、属性ダメージ合計、表示中の敵
- **useCallback**: イベントハンドラー、ゲームロジック関数
- **条件付きレンダリング**: ゲーム状態に応じてコンポーネントを表示/非表示

### 状態更新

- 配列の更新は必要な場合のみ実行
- 攻撃処理で敵配列を正しく引き継ぎ（`processPlayerAttack` → `processEnemyAIAndAttacks`）
- 死亡した敵は配列から除去

## 将来の拡張案

### 未実装機能

1. **装備強化システム**: 所持装備のレベルアップ
2. **スキルシステム**: 特殊技の実装
3. **クエストシステム**: 目標達成型のミッション
4. **マルチプレイヤー**: 協力プレイや対戦モード
5. **ボスバトル**: エリア最後の強敵との戦闘
6. **実績システム**: 特定条件達成での報酬

### 拡張の指針

新機能を追加する際は、以下のファイルを修正します：

1. **型定義**: `types.ts` に新しい型を追加
2. **定数**: `constants/` に関連定数を追加
3. **ロジック**: `hooks/` または `utils/` に処理を実装
4. **UI**: `components/` に新しいコンポーネントを追加
5. **データ**: `data/` にマスターデータを追加
